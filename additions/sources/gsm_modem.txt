Задача в очереди: указатель на функцию обработки задачи – чтение смс, отправка смс, отправка команд
		
Структура - задача приёма смс:
	Массив символов порядкового номера смс для чтения
	Флаги процесса:
		- запрос на чтение смс выполнен
		- запрос на удаление прочитанного смс выполнен

Структура - задача отправки смс:
	Флаги процесса:
		- запрос на передачу смс отправлен
		- текст смс отправлен в модем
	Массив для записи текста смс для отправки
	
Структура - задача отправки команд в модем:
	Флаги процесса приёма/отправки смс и отправки команд:
		- текст команды отправлен в модем
	указатель на AT-команду	во флэш
	указатель на параметр AT-командыво флэш
	
Алгоритм работы кольца очереди – сначала пишем/читаем, потом сдвигаем индекс, чтобы при выполнении задачи удалить её сдвигом индекса хвоста

//#################### Параметры модема, записать перед установкой в устройство ##############
запись ATE0 //отключить эхо от модема
запись AT+IPR=9600 //скорось 9600
запись AT+IFC=1,0 //контроль приёма терминалом от модема XON/XOFF, контроля приёма модемом от терминала нет
запись AT+CMEE=0 //расшифровка ошибкок отключена
запись AT+CMGF=1 //текстовый режим
запись AT+CSCS="GSM" //кодировка GSM
запись AT+CSCB=1 //запрет специальных сообщений
запись AT&W0//записать параметры в профиль
запись AT+GSMBUSY=1 //запрет всех входящих звонков, не сохраняется

Включаем модем через PWRKEY - внешний ключ, коротит PWRKEY на 0 на 1с при подаче питания на всё устройство

//########################### Определение конца получения посылки от модема: ########################
	При каждом входе в ISR(USART_RX_vect) обнуляется счётчик паузы приёма байтов, обновляемый в ISR(TIMER0_OVF_vect)
	Счётчик паузы приёма байтов в ISR(TIMER0_OVF_vect) ограничен 1с.
	В ISR(TIMER0_OVF_vect) по достижении счётчиком порога 1с (после получения от модема последнего символа прошла 1с)
		Останавливаем прирост счётчика 
		Шлём в модем XOFF
		Ставим флаг разрешения выгрузки кольца в msg
		Счётчик +=1 (чтобы не слать XOFF и не поднимать флаг повторно без оснований)
		Выходим из прерывания

//############################ В начале main ##################
Блок запуска модема при старте
	счётчик паузы приёма байтов, обновляемый в ISR(TIMER0_OVF_vect) = (макс/знач.+1)
	сброс флага разрешения выгрузки кольца в msg
	запускаем счётчик таймаута включения (15с)
	Включаем прерывания на приём
	сброс флага готовности модема
	Обнуляем msg
	создаём задачу удалить все смс из модема (AT+CMGD=1,4)

//############################ В начале основного цикла ##################	
Если флаг разрешения выгрузки кольца в msg поднят: 
	выгружаем в msg
	снимаем флаг разрешения выгрузки кольца в msg
	Шлём в модем XON
	Если модем активен
	- Передаём msg в парсер
	//ищем ОК и > и фиксируем во флагах, потом разбираем остальной текст в msg и освобождаем его для новой загрузки; ключевой момент - после URC нет ОК!, поэтому
	//если ждём ответ на команду, важно знать только есть ли ОК или > в ответе, текст перед ОК и так понятно какой будет; флаги нужны, чтобы не держать msg зря, handler-ам нужен только ОК или >
	- парсер ищет:
		- "r/n/OKr/n", ставит флаг OK
		- "r/n>", ставит флаг INVITE 
		- "r/n/+cmgr:", если есть:
			- Если телефон правильный - выполняем разбор, предаём в блок обработки команд
				- если команда правильная (в тесте команда request)
					- выполняем (в тесте отправка смс answer)
					- если надо, ставим задачу на отправку смс
				- если команда не правильная - ставим задачу на отправку смс (неверная команда)
			- Если телефон неправильный - игнорируем
		- "r/n/+csq:_", если есть, распознаём уровень сигнала, меням значение переменной
		- "r/n/+cmti:", если есть, ставим в очередь задание на чтение смс, ищем следующее "r/n/+cmti:"
		Добавить:
		- "\r\n+CUSD:"
			- если есть - ищем "0,Balance:240,68r.....\r\n", ставим задачу на отправку смс
	
//## Блок инициализации модема после включения или сброса, внутрь попадаем только если где-то прошёл сброс флага готовности модема и сделан сброс модема любым способом ##
Проверяем флаг готовности модема
	Если стоит - выходим в главный цикл
	Если нет, смотрим флаг отправки команды запрета входящих звонков AT+GSMBUSY=1
		Если сброшен, значит первый заход после сброса/включения, в msg ищем "Ready\r\n"
		/*ответ "\r\nRDY\r\n\r\n+CFUN: 1\r\n\r\n+CPIN: READY\r\n\r\nCall Ready\r\n" - при NRESET*/
			Если есть
				отправляем AT+GSMBUSY=1 //запрет всех входящих звонков
				запускаем счётчик таймаута (3с)
				ставим флаг "запрет входящих звонков отправлен в модем"
				возврат в начало главного цикла
			Если нет - проверяем таймер
				Если не дошёл – возврат в начало главного цикла
				Если перешёл:
					обнуляем msg
					NRESET // сброс модема
					запускаем счётчик таймаута
					возврат в начало главного цикла
		Если стоит флаг "запрет входящих звонков отправлен в модем" - в msg ищем "\r\nOK\r\n"
			Если есть:
				Ставим флаг готовности модема
				обнуляем флаги сброса
				обнуляем msg
				выходим в главный цикл
			Если нет - проверяем таймер
				Если не дошёл – возврат в начало главного цикла
				Если перешёл:
					обнуляем msg
					NRESET // сброс модема
					запускаем счётчик таймаута активации(15с)
					обнуляем флаги отправки команд				
					возврат в начало главного цикла
				
Переход к обработчику очереди - берёт текущий указатель на функцию обработки задачи

Если указатель на приём смс, берёт задачу из массива задач на чтение:
	Проверка флага состояния задачи
		Если флаги нули:
			запрос модему на приём смс с порядковым номером из структуры задачи "AT+CMGR=n"
			подъём флага "запрос на чтение смс выполнен"
			обнуляем счётчик таймаута
			выход в тело
		Если стоит флаг "запрос на чтение смс выполнен" – проверяем флаг ОК
			Если 1:
				отправляем в модем команду удалить прочитанное смс "AT+CMGD=n"
				ставим флаг "запрос на удаление прочитанного смс выполнен"
				обнуляем счётчик таймаута
				обнуляем msg
				выходим в тело
			Если 0 – проверяем счётчик таймаута
				Если не дошёл – выходим в тело
				Если перешёл:
					сброс флагов задачи
					сброс флага готовности модема
					обнуляем msg
					NRESET // сброс модема
					выходим в тело
		Если стоит флаг "запрос на удаление прочитанного смс выполнен" - проверяем флаг ОК
				Если 1:
					увеличиваем индекс хвоста очереди – задача выполнена
					увеличиваем индекс хвоста задач на чтение – задача выполнена
					обнуляем флаги
					обнуляем msg
					выходим в тело
				Если 0 – проверяем таймер
					Если не дошёл – выходим в тело
					Если перешёл:
						возвращаем флаг "запрос на чтение смс выполнен"
						сброс флага готовности модема
						обнуляем msg
						NRESET // сброс модема
						выходим в тело
						
Если указатель на отправку смс, берёт задачу из массива задач на отправку:
	Проверка флага состояния задачи:
		Если флаги нули:
			делаем запрос на передачу "AT+CMGS="+790XXXXXXXX""
			обнуляем таймер таймаута
			переводим флаг на "запрос на передачу смс отправлен"
			выходим в тело
		Если стоит флаг "запрос на передачу отправлен", проверяем флаг INVITE
			Если 1:
				отправляем в модем текст из массива структуры, в конце символ SUB (26 в ASCII)
				переводим флаг на "текст смс отправлен в модем"
				обнуляем таймер таймаута
				обнуляем msg
				выходим в тело
			Если 0, проверяем таймер:
				Если не дошёл – выходим в тело
				Если перешёл:
					сброс флагов задачи
					сброс флага готовности модема
					обнуляем msg
					NRESET // сброс модема
					выходим в тело
		Если стоит флаг "текст смс отправлен в модем" – проверяем флаг ОК
			Если 1:
				увеличиваем индекс хвоста очереди – задача выполнена
				увеличиваем индекс хвоста задач на отправку – задача выполнена
				обнуляем флаги
				обнуляем msg
				выходим в тело
			Если 0 – проверяем таймер
				Если не дошёл – выходим в тело
				Если перешёл:
					сброс флагов задачи
					сброс флага готовности модема
					обнуляем msg
					NRESET // сброс модема
					выходим в тело

Если указатель на отправку команды, берёт задачу из массива задач на отправку команд:
	Если флаг нуль
		Собираем команду по указателям из задачи
		Отправляем команду в модем
		запускаем таймер
		Ставим флаг "текст команды отправлен в модем"
		выходим в тело
	Если стоит флаг "текст команды отправлен в модем" - проверяем флаг ОК
			Если 1:
				увеличиваем индекс хвоста очереди – задача выполнена
				увеличиваем индекс хвоста задач отправки команд – задача выполнена
				обнуляем флаги
				обнуляем msg
				выходим в тело
			Если 0 – проверяем таймер
				Если не дошёл – выходим в тело
				Если перешёл:
					снимаем флаг "текст команды отправлен в модем"
					сброс флага готовности модема
					обнуляем msg
					NRESET // сброс модема
					выходим в тело
					